<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Client Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .progress-bar { transition: width 0.5s ease; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

<div id="app" v-cloak class="min-h-screen p-6">

    <div class="max-w-7xl mx-auto mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">
                <i class="fa-solid fa-server mr-2 text-indigo-600"></i> AI Client Manager
            </h1>
            <p class="text-sm text-gray-500 mt-1">Last Updated: {{ lastUpdated }}</p>
        </div>
        <div class="flex space-x-4">
             <button @click="fetchData" class="px-4 py-2 bg-white border rounded shadow hover:bg-gray-50 text-sm">
                <i class="fa-solid fa-rotate-right" :class="{'fa-spin': loading}"></i> Refresh
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" v-if="stats.summary">
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-indigo-500">
            <div class="text-gray-500 text-sm uppercase font-semibold">Total Clients</div>
            <div class="text-3xl font-bold mt-2">{{ stats.summary.total_clients }}</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
            <div class="text-gray-500 text-sm uppercase font-semibold">Available</div>
            <div class="text-3xl font-bold mt-2 text-green-600">{{ stats.summary.available }}</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
            <div class="text-gray-500 text-sm uppercase font-semibold">Busy / Active</div>
            <div class="text-3xl font-bold mt-2 text-yellow-600">{{ stats.summary.busy }}</div>
            <div class="text-xs text-gray-400 mt-1">Load: {{ stats.summary.system_load }}</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-red-500">
            <div class="text-gray-500 text-sm uppercase font-semibold">Errors / Unavail</div>
            <div class="text-3xl font-bold mt-2 text-red-600">{{ stats.summary.clients_with_errors }}</div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-700">Client Instances</h2>
            <span class="text-xs px-2 py-1 bg-gray-200 rounded text-gray-600">Auto-refresh: 2s</span>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client Name / Priority</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Health & Metrics</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Allocation</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Runtime Stats</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <tr v-for="client in stats.clients" :key="client.meta.name" class="hover:bg-gray-50 transition">

                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div>
                                    <div class="text-sm font-bold text-gray-900">{{ client.meta.name }}</div>
                                    <div class="text-xs text-gray-500">Type: {{ client.meta.type }}</div>
                                    <div class="text-xs text-gray-500">Priority: <span class="font-mono bg-gray-100 px-1 rounded">{{ client.meta.priority }}</span></div>
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap">
                            <span :class="getStatusBadgeClass(client)" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full items-center">
                                <span class="w-2 h-2 rounded-full mr-2" :class="getStatusDotClass(client)"></span>
                                {{ formatStatus(client.state.status) }}
                            </span>
                            <div v-if="client.state.is_busy" class="text-xs text-yellow-600 mt-1 font-semibold animate-pulse">● IN USE</div>
                        </td>

                        <td class="px-6 py-4 align-top w-64">
                            <div class="mb-2">
                                <div class="flex justify-between text-xs mb-1">
                                    <span>Health</span>
                                    <span class="font-bold">{{ client.state.health_score }}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="h-2 rounded-full progress-bar"
                                         :class="getHealthColor(client.state.health_score)"
                                         :style="{ width: client.state.health_score + '%' }"></div>
                                </div>
                            </div>

                            <div v-if="client.metrics && client.metrics.length > 0" class="space-y-1">
                                <div v-for="m in client.metrics.slice(0, 2)" class="text-xs text-gray-500 flex justify-between">
                                    <span>{{ formatMetricKey(m.key) }}:</span>
                                    <span>{{ formatNumber(m.current) }} / {{ formatNumber(m.target) }}</span>
                                </div>
                            </div>
                            <div v-else class="text-xs text-gray-300 italic">No usage limits</div>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div v-if="client.allocation.held_by" class="bg-indigo-50 border border-indigo-100 rounded p-2">
                                <div class="text-indigo-700 font-bold"><i class="fa-regular fa-user mr-1"></i> {{ client.allocation.held_by }}</div>
                                <div class="text-xs mt-1">Duration: {{ formatDuration(client.allocation.duration_seconds) }}</div>
                            </div>
                            <div v-else class="text-gray-400 text-xs">
                                Idle
                            </div>
                            <div class="text-xs text-gray-400 mt-1">
                                Last Active: {{ timeAgo(client.state.last_active_ts) }}
                            </div>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-xs">
                            <div class="flex flex-col space-y-1">
                                <span class="text-gray-600">Calls: <b>{{ client.runtime_stats.acquire_count }}</b></span>
                                <span class="text-gray-600">Errors: <b :class="{'text-red-600': client.runtime_stats.error_count > 0}">{{ client.runtime_stats.error_count }}</b></span>
                                <span class="text-gray-400">Rate: {{ client.runtime_stats.error_rate_percent }}%</span>
                            </div>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex flex-col space-y-2 items-end">
                                <button @click="triggerCheck(client.meta.name)" class="text-indigo-600 hover:text-indigo-900 text-xs bg-indigo-50 px-2 py-1 rounded border border-indigo-200 hover:bg-indigo-100 transition">
                                    <i class="fa-solid fa-stethoscope mr-1"></i> Check Health
                                </button>

                                <div class="relative group">
                                    <button class="text-gray-500 hover:text-gray-700 text-xs px-2 py-1">
                                        Change Status <i class="fa-solid fa-caret-down"></i>
                                    </button>
                                    <div class="absolute right-0 mt-1 w-32 bg-white border border-gray-200 shadow-lg rounded hidden group-hover:block z-10">
                                        <a href="#" @click.prevent="setStatus(client.meta.name, 'available')" class="block px-4 py-2 text-xs text-gray-700 hover:bg-green-50 hover:text-green-700">Set Available</a>
                                        <a href="#" @click.prevent="setStatus(client.meta.name, 'error')" class="block px-4 py-2 text-xs text-gray-700 hover:bg-red-50 hover:text-red-700">Set Error</a>
                                        <a href="#" @click.prevent="setStatus(client.meta.name, 'unavailable')" class="block px-4 py-2 text-xs text-gray-700 hover:bg-gray-100">Set Unavailable</a>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                stats: { summary: null, clients: [] },
                loading: false,
                lastUpdated: '-',
                timer: null
            }
        },
        mounted() {
            this.fetchData();
            // 自动刷新
            this.timer = setInterval(this.fetchData, 2000);
        },
        methods: {
            async fetchData() {
                // 不在后台刷新时显示 loading，以免 UI 闪烁
                try {
                    const res = await fetch('/api/overview');
                    const data = await res.json();
                    this.stats = data;
                    this.lastUpdated = new Date().toLocaleTimeString();
                } catch (e) {
                    console.error("Fetch error", e);
                }
            },
            async triggerCheck(name) {
                if(!confirm(`Force health check for ${name}?`)) return;
                try {
                    await fetch(`/api/clients/${name}/check`, { method: 'POST' });
                    // 立即刷新一次
                    setTimeout(this.fetchData, 500);
                } catch (e) { alert("Action failed"); }
            },
            async setStatus(name, status) {
                if(!confirm(`Set ${name} to ${status}?`)) return;
                try {
                    await fetch(`/api/clients/${name}/status`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({status: status})
                    });
                    setTimeout(this.fetchData, 500);
                } catch (e) { alert("Action failed"); }
            },
            // --- Helpers for UI ---
            formatStatus(statusEnum) {
                // statusEnum usually matches "ClientStatus.AVAILABLE" string
                return statusEnum.split('.').pop();
            },
            getStatusBadgeClass(client) {
                const s = String(client.state.status);
                if (s.includes('AVAILABLE')) return 'bg-green-100 text-green-800';
                if (s.includes('ERROR')) return 'bg-red-100 text-red-800';
                if (s.includes('UNAVAILABLE')) return 'bg-gray-100 text-gray-800';
                return 'bg-blue-100 text-blue-800';
            },
            getStatusDotClass(client) {
                const s = String(client.state.status);
                if (s.includes('AVAILABLE')) return 'bg-green-500';
                if (s.includes('ERROR')) return 'bg-red-500';
                return 'bg-gray-500';
            },
            getHealthColor(score) {
                if (score > 80) return 'bg-green-500';
                if (score > 50) return 'bg-yellow-500';
                return 'bg-red-500';
            },
            formatMetricKey(key) {
                return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            },
            formatNumber(num) {
                if (num >= 1000) return (num/1000).toFixed(1) + 'k';
                return num;
            },
            formatDuration(seconds) {
                if (seconds < 60) return parseInt(seconds) + 's';
                return parseInt(seconds / 60) + 'm';
            },
            timeAgo(ts) {
                if (!ts) return '-';
                const diff = (Date.now()/1000) - ts;
                if (diff < 60) return parseInt(diff) + 's ago';
                if (diff < 3600) return parseInt(diff/60) + 'm ago';
                return parseInt(diff/3600) + 'h ago';
            }
        }
    }).mount('#app');
</script>
</body>
</html>
